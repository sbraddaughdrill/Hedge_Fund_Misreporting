group_var=group_var,group=group,quantile_var=quantile_var,.progress = "text", .inform = FALSE,.parallel = FALSE, .paropts = NULL)
quantiles_pct_flow <- do.call(rbind.fill, quantiles_pct_flow_temp)
rm(quantiles_pct_flow_temp)
quantiles_pct_flow <- quantiles_pct_flow[,c(group_var,"variable_indep",quantile_var[2],
colnames(quantiles_pct_flow[,!(colnames(quantiles_pct_flow) %in% c(group_var,"variable_indep",quantile_var[2]))]))]
colnames(quantiles_pct_flow) <- c(group_var,"cut_var",quantile_var[2],paste("X",seq(0,(quantile_count_dep-1)),sep=""))
row.names(quantiles_pct_flow) <- seq(nrow(quantiles_pct_flow))
rm(note,group_var,quantile_count_dep,quantile_count_indep,quantile_type,group)
return(quantiles_pct_flow)
}
univariate_bins_manual <- function(data,dep_var,dep_vars_all,vars_indep,parameters,quantile_var,breaks){
# dep_var <- dep_var
# vars_indep <- univariate_vars_indep_manual
# parameters <- x
# quantile_var <- c("quantile_var_indep1","quantile_var_indep2")
require(plyr)
note <- parameters$note
group_var <- parameters$group_var
quantile_count_dep <- as.integer(parameters$nums)
quantile_count_indep <- 1
quantile_type <- "quantile"
group <- parameters$type
quantiles_pct_flow_temp <- llply(.data=vars_indep,.fun=function(v,data,dep_var,quantile_type,quantile_count_dep,quantile_count_indep,group_var,group,quantile_var,breaks){
# v <- vars_indep[[1]]
indep_var <- unlist(v)
cat("\n","INDEP VAR:",indep_var, "\n")
#cat("CUT", "\n")
if (group == "year") {
quantiles3 <- quantile_cuts_manual2(indep_var,data=data,dep_var=dep_var,quantile_count_dep=quantile_count_dep,quantile_count_indep=1,group_var=group_var,
quantile_var=quantile_var,cut_group1=c(group_var),cut_group2=c(group_var,quantile_var[1]),breaks=breaks)
} else if (group == "agg") {
quantiles3 <- quantile_cuts_manual2(indep_var,data=data,dep_var=dep_var,quantile_count_dep=quantile_count_dep,quantile_count_indep=1,group_var=group_var,
quantile_var=quantile_var,cut_group1=NULL,cut_group2=c(quantile_var[1]),breaks=breaks)
} else {
cat("ERROR IN GROUPS", "\n")
}
#cat("MELT", "\n")
quantiles_melt <- quantile_melt2(quantiles=quantiles3,dep_var=dep_var,indep_var=indep_var,group_var=group_var,quantile_var=quantile_var)
#quantiles_melt2 <- quantiles_melt
if (quantile_type == "dv") {
quantiles_melt[,quantile_var[1]] <- quantiles_melt[,"value_indep"]
}
#quantiles_melt1 <- quantiles_melt
#cat("CAST", "\n")
quantiles_cast <- quantile_cast2(quantiles_melt=quantiles_melt,group_var=group_var,quantile_var=quantile_var)
},data=data,dep_var=dep_var,quantile_type=quantile_type,quantile_count_dep=quantile_count_dep,quantile_count_indep=1,
group_var=group_var,group=group,quantile_var=quantile_var,breaks=breaks,.progress = "text", .inform = FALSE,.parallel = FALSE, .paropts = NULL)
quantiles_pct_flow <- do.call(rbind.fill, quantiles_pct_flow_temp)
rm(quantiles_pct_flow_temp)
quantiles_pct_flow <- quantiles_pct_flow[,c(group_var,"variable_indep",quantile_var[2],
colnames(quantiles_pct_flow[,!(colnames(quantiles_pct_flow) %in% c(group_var,"variable_indep",quantile_var[2]))]))]
colnames(quantiles_pct_flow) <- c(group_var,"cut_var",quantile_var[2],paste("X",seq(1,quantile_count_dep),sep=""))
row.names(quantiles_pct_flow) <- seq(nrow(quantiles_pct_flow))
rm(note,group_var,quantile_count_dep,quantile_count_indep,quantile_type,group)
return(quantiles_pct_flow)
}
univariate_bins_diff <- function(bins,range_str,quantile_first_col,quantile_last_col,dep_var,dep_vars_all,vars_indep,parameters,quantile_var){
# bins <- quantiles_pct_flow
# range_str <- "yearly"
# bins <- bins_trim
# range_str <- paste(Start_yr,End_yr,sep="_")
### Continuous
# quantile_first_col <- "X1"
# quantile_last_col <- paste("X",quantile_count_dep,sep="")
# vars_indep <- univariate_vars_indep_continuous
### Binary
# quantile_first_col <- "X0"
# quantile_last_col <- paste("X",(quantile_count_dep-1),sep="")
# vars_indep <- univariate_vars_indep_binary
# dep_var <- dep_var
# dep_vars_all <- dep_vars_all
# parameters <- x
# quantile_var <- quantile_var
# quantile_first_col <- quantile_first_col
# quantile_last_col <- quantile_last_col
require(plyr)
note <- parameters$note
group_var <- parameters$group_var
quantile_count_dep <- as.integer(parameters$nums)
group <- parameters$type
output_dir <- parameters$output_dir
name1 <- paste("quantiles",group,dep_var,range_str,note,quantile_count_dep,sep="_")
#averages_yr_quan_all_cast <- diff_in_mean(bins,c("cut_var",quantile_var[2]),group_var,quantile_first_col,quantile_last_col)
averages_yr_quan_all_cast <- diff_in_mean2(bins,c("cut_var",quantile_var[2]),group_var,quantile_first_col,quantile_last_col)
averages_yr_quan_all_cast <- ddply(.data=averages_yr_quan_all_cast, .variables=c(group_var,quantile_var[2]),
.fun = function(x,var_order){x[order(order(var_order)),] },var_order=vars_indep)
averages_yr_quan_all_cast <- averages_yr_quan_all_cast[!(averages_yr_quan_all_cast[,"cut_var"] %in% dep_vars_all),]
row.names(averages_yr_quan_all_cast) <- seq(nrow(averages_yr_quan_all_cast))
for (j in 4:ncol(averages_yr_quan_all_cast))
{
# j <- 1
averages_yr_quan_all_cast[,j] <- ifelse(is.infinite(averages_yr_quan_all_cast[,j]), NA, averages_yr_quan_all_cast[,j])
averages_yr_quan_all_cast[,j] <- ifelse(is.na(averages_yr_quan_all_cast[,j]), NA, averages_yr_quan_all_cast[,j])
}
rm(j)
averages_yr_quan_all_cast[,"t_stat"] <- ifelse(is.na(averages_yr_quan_all_cast[,"t_p_val"]), NA, averages_yr_quan_all_cast[,"t_stat"])
averages_yr_quan_all_cast[,"t_p_val"] <- ifelse(is.na(averages_yr_quan_all_cast[,"t_stat"]), NA, averages_yr_quan_all_cast[,"t_p_val"])
averages_yr_quan_all_cast[,"f_stat"] <- ifelse(is.na(averages_yr_quan_all_cast[,"f_p_val"]), NA, averages_yr_quan_all_cast[,"f_stat"])
averages_yr_quan_all_cast[,"f_p_val"] <- ifelse(is.na(averages_yr_quan_all_cast[,"f_stat"]), NA, averages_yr_quan_all_cast[,"f_p_val"])
averages_yr_quan_all_cast <- averages_yr_quan_all_cast[,c(group_var,quantile_var[2],"cut_var",colnames(averages_yr_quan_all_cast[,!(colnames(averages_yr_quan_all_cast) %in% c(group_var,quantile_var[2],"cut_var"))]))]
averages_yr_quan_all_cast2 <- data.frame(averages_yr_quan_all_cast,t_p_val_str=NA,f_p_val_str=NA,stringsAsFactors=FALSE)
averages_yr_quan_all_cast2[,"t_p_val_str"] <- ifelse(averages_yr_quan_all_cast2[,"t_p_val"] < .0100, "***",
ifelse(averages_yr_quan_all_cast2[,"t_p_val"] < .0500, "** ",
ifelse(averages_yr_quan_all_cast2[,"t_p_val"] < .1000, "*  ", "   ")))
averages_yr_quan_all_cast2[,"t_p_val_str"] <- ifelse(is.na(averages_yr_quan_all_cast2[,"t_p_val_str"]),"",averages_yr_quan_all_cast2[,"t_p_val_str"])
averages_yr_quan_all_cast2[,"f_p_val_str"] <- ifelse(averages_yr_quan_all_cast2[,"f_p_val"] < .0100, "***",
ifelse(averages_yr_quan_all_cast2[,"f_p_val"] < .0500, "** ",
ifelse(averages_yr_quan_all_cast2[,"f_p_val"] < .1000, "*  ", "   ")))
averages_yr_quan_all_cast2[,"f_p_val_str"] <- ifelse(is.na(averages_yr_quan_all_cast2[,"f_p_val_str"]),"",averages_yr_quan_all_cast2[,"f_p_val_str"])
averages_yr_quan_all_cast2[,4:(ncol(averages_yr_quan_all_cast2)-2)] <- format(round(averages_yr_quan_all_cast2[,4:(ncol(averages_yr_quan_all_cast2)-2)],  digits = 4))
averages_yr_quan_all_cast2[,"t_stat"] <- paste(averages_yr_quan_all_cast2[,"t_stat"],averages_yr_quan_all_cast2[,"t_p_val_str"],sep="")
averages_yr_quan_all_cast2[,"f_stat"] <- paste(averages_yr_quan_all_cast2[,"f_stat"],averages_yr_quan_all_cast2[,"f_p_val_str"],sep="")
averages_yr_quan_all_cast2[,"t_p_val"] <- paste(averages_yr_quan_all_cast2[,"t_p_val"],averages_yr_quan_all_cast2[,"t_p_val_str"],sep="")
averages_yr_quan_all_cast2[,"f_p_val"] <- paste(averages_yr_quan_all_cast2[,"f_p_val"],averages_yr_quan_all_cast2[,"f_p_val_str"],sep="")
averages_yr_quan_all_cast2 <- averages_yr_quan_all_cast2[!is.na(averages_yr_quan_all_cast2[,group_var]),]
write.csv(averages_yr_quan_all_cast2,file=paste(output_dir,name1,".csv",sep=""),na="",quote=TRUE,row.names=FALSE)
rm(note,group_var,quantile_count_dep,group,output_dir,name1)
return(averages_yr_quan_all_cast2)
}
###############################################################################
cat("SECTION: LIBRARIES", "\n")
###############################################################################
#Load External Packages
# c("compare","cwhmisc","data.table","descr","fastmatch","formatR",
#   "gtools","Hmisc","installr","knitr","leaps","lmtest","markdown","memisc","mitools",
#   "pander","pbapply","PerformanceAnalytics","plm","psych","quantreg","R.oo","R2wd",
#   "reporttools","reshape2","rms","sandwich","sqldf","stargazer","stringr",
#   "texreg","taRifx","UsingR","xtable","zoo")
external_packages <- c("plyr","gdata","RSQLite")
invisible(unlist(sapply(external_packages,load_external_packages, repo_str=repo, simplify=FALSE, USE.NAMES=FALSE)))
installed_packages <- list_installed_packages(external_packages)
rm2(repo,external_packages,installed_packages)
###############################################################################
cat("SECTION: SQLITE DATABASES", "\n")
###############################################################################
#crsp_db <- paste(output_directory,"CRSPMF_Formatted.s3db",sep="")
#mflinks_db <- paste(output_directory,"MFLinks_Formatted.s3db",sep="")
#msd_db <- paste(output_directory,"MDMF_Formatted.s3db",sep="")
#similarity_db <- paste(output_directory,"Similarity_Analysis.s3db",sep="")
#descriptive_stats_db <- paste(output_directory,"Descriptive_stats.s3db",sep="")
#data_fulll_db <- paste(output_directory,"Data_full.s3db",sep="")
###############################################################################
cat("IMPORT DATA", "\n")
###############################################################################
identifier <- "Fund_ID"
start_year <- 1994
#start_year <- 2007
end_year <- 2013
#strat_col <- "main_investment_strategy"
strat_col <- "Primary_Investment_Strategy_combcol"
#descriptive_stats_tables <- ListTables(descriptive_stats_db)
#descriptive_stats_fields <- ListFields(descriptive_stats_db)
data_all0 <- read.csv(file=paste(output_directory,"data_all_tone",".csv",sep=""),header=TRUE,na.strings="NA",stringsAsFactors=FALSE)
data_all0 <- data_all0[order(data_all0[,identifier],
data_all0[,"yr"],
data_all0[,"month"]),]
row.names(data_all0) <- seq(nrow(data_all0))
###############################################################################
cat("TRIM DATA", "\n")
###############################################################################
#data_all0 <- data_all0[(data_all0[,"yr"]>=start_year & data_all0[,"yr"]<=end_year),]
data_all0 <- data_all0[,!(colnames(data_all0) %in% c("Fund_Name","Secondary_Investment_Strategy","Strategy","Strat_ID"))]
###############################################################################
cat("CLEAN DATA", "\n")
###############################################################################
data_all0[,"date"] <- as.Date(data_all0[,"date"],format="%Y-%m-%d")
data_all0[,"Date_Added"] <- as.Date(data_all0[,"Date_Added"],format="%Y-%m-%d")
data_all0[,"chgdt"] <- as.Date(data_all0[,"chgdt"],format="%Y-%m-%d")
data_all0[,"Inception_Date"] <- as.Date(data_all0[,"Inception_Date"],format="%Y-%m-%d")
data_all0[,strat_col] <- ifelse(data_all0[,strat_col]=="",NA,data_all0[,strat_col])
for(k in which(sapply(data_all0,class)!="Date"))
{
#k <- 1
data_all0[[k]] <- unknownToNA(data_all0[[k]], unknown=unknowns_strings,force=TRUE)
data_all0[[k]] <- ifelse(is.na(data_all0[[k]]),NA,data_all0[[k]])
}
rm2(k)
###############################################################################
cat("WINSORIZE", "\n")
###############################################################################
winsorize_vars <- c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios",
"avg_grade_level_ios","avg_grade_level_ac_ios","avg_grade_level_acf_ios",
"all_similarity_050pct_ios","Primary_Investment_Strategy_combcol_similarity_050pct_ios",
"all_similarity_100pct_ios","Primary_Investment_Strategy_combcol_similarity_100pct_ios",
"all_similarity_250pct_ios","Primary_Investment_Strategy_combcol_similarity_250pct_ios",
"all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios",
"all_similarity_750pct_ios","Primary_Investment_Strategy_combcol_similarity_750pct_ios",
"all_similarity_900pct_ios","Primary_Investment_Strategy_combcol_similarity_900pct_ios")
data_all <- data_all0
# for (i in 1:length(winsorize_vars))
# {
#   #i <- 1
#   #i <- 2
#   data_all[,winsorize_vars[i]] <- winsorize_both(data_all[,winsorize_vars[i]],q=0.025)
#
# }
# rm(i)
rm2(data_all0,winsorize_vars)
###############################################################################
cat("UNIVARIATE ANALYSIS - VARIABLES", "\n")
###############################################################################
### Dep Vars (Text Vars)
univariate_vars_dep <- c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios",
"avg_grade_level_ios","avg_grade_level_ac_ios","avg_grade_level_acf_ios",
"all_similarity_050pct_ios","Primary_Investment_Strategy_combcol_similarity_050pct_ios",
"all_similarity_100pct_ios","Primary_Investment_Strategy_combcol_similarity_100pct_ios",
"all_similarity_250pct_ios","Primary_Investment_Strategy_combcol_similarity_250pct_ios",
"all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios",
"all_similarity_750pct_ios","Primary_Investment_Strategy_combcol_similarity_750pct_ios",
"all_similarity_900pct_ios","Primary_Investment_Strategy_combcol_similarity_900pct_ios",
"per_litigious","per_modalstrong","per_modalweak","per_negative","per_positive","per_uncertainty")
### All pattern cols
pattern_cols_99 <- c("per_positive_percent_99","num_zero_percent_99","per_repeats_percent_99","uniform_percent_99",
"string_percent_99","num_pairs_percent_99","per_negative_percent_99","ar_1_percent_99","indexrsq_percent_99",
"kink_percent_99","quality_score_trim0_99","quality_score_trim1_99","quality_score_trim2_99")
pattern_cols_95 <- c("per_positive_percent_95","num_zero_percent_95","per_repeats_percent_95","uniform_percent_95",
"string_percent_95","num_pairs_percent_95","per_negative_percent_95","ar_1_percent_95","indexrsq_percent_95",
"kink_percent_95","quality_score_trim0_95","quality_score_trim1_95","quality_score_trim2_95")
pattern_cols_90 <- c("per_positive_percent_90","num_zero_percent_90","per_repeats_percent_90","uniform_percent_90",
"string_percent_90","num_pairs_percent_90","per_negative_percent_90","ar_1_percent_90","indexrsq_percent_90",
"kink_percent_90","quality_score_trim0_90","quality_score_trim1_90","quality_score_trim2_90")
pattern_cols_trim0 <- c(pattern_cols_99,pattern_cols_95,pattern_cols_90)
pattern_cols_trim1 <- pattern_cols_trim0[!(pattern_cols_trim0 %in% c(pattern_cols_trim0[grep("per_positive",pattern_cols_trim0)],pattern_cols_trim0[grep("per_repeats",pattern_cols_trim0)]))]
#pattern_cols_trim1 <- pattern_cols_trim0[!(pattern_cols_trim0 %in% c(pattern_cols_trim0[grep("per_positive",pattern_cols_trim0)]))]
pattern_cols_trim2 <- pattern_cols_trim1[!(pattern_cols_trim1 %in% c(pattern_cols_trim1[grep("trim0",pattern_cols_trim1)],pattern_cols_trim1[grep("trim1",pattern_cols_trim1)]))]
#pattern_cols_trim2 <- pattern_cols_trim1[!(pattern_cols_trim1 %in% c(pattern_cols_trim1[grep("trim0",pattern_cols_trim1)],pattern_cols_trim1[grep("trim2",pattern_cols_trim1)]))]
pattern_cols <- pattern_cols_trim2[grep("_90", pattern_cols_trim2)]
### Continuous Vars
univariate_vars_continuous_fund <- c("pflow","sdpct_flow_lag1",
"mktadjret",
"mktadjret_sq",
"age_y","total_fee","Sharpe_Ratio","Sortino_Ratio")
#"pflow_lag1","pflow_lag2","pflow_lag3","pflow_lag4",
#"mktadjret_lag1","mktadjret_lag2","mktadjret_lag3","mktadjret_lag4",
#"mktadjret_sq_lag1","mktadjret_sq_lag2","mktadjret_sq_lag3","mktadjret_sq_lag4",
#"AUM_log_lag1","AUM_log_lag2","AUM_log_lag3","AUM_log_lag4",
univariate_vars_continuous_pattern <- pattern_cols[(pattern_cols %in% pattern_cols[grep("quality_score",pattern_cols)])]
#univariate_vars_continuous <- c(univariate_vars_continuous_fund,univariate_vars_continuous_pattern)
univariate_vars_continuous <- c(univariate_vars_continuous_fund)
### Binary Vars
univariate_vars_binary_fund <- c("Listed_on_Exchange_bin","Hurdle_Rate_bin","Domicile_onshore_bin","Leverage_bin","Lockup_bin",
"Flagship_bin","Closed_bin","Dead_bin")
#"high_water_mark_bin"
univariate_vars_binary_pattern <- pattern_cols[!(pattern_cols %in% pattern_cols[grep("quality_score",pattern_cols)])]
univariate_vars_binary <- c(univariate_vars_binary_fund,univariate_vars_binary_pattern)
rm2(pattern_cols_99,pattern_cols_95,pattern_cols_90)
rm2(pattern_cols_trim0,pattern_cols_trim1,pattern_cols_trim2)
###############################################################################
cat("UNIVARIATE ANALYSIS - CONTINUOUS", "\n")
###############################################################################
output_directory_univariate_continuous <- paste(output_directory,"univariate_continuous","\\",sep="")
create_directory(output_directory_univariate_continuous,remove=1)
data_all_univariate_continuous <- data_all[,c("yr","yr_month",univariate_vars_dep,univariate_vars_continuous)]
univariate_continuous_quantiles <- 4
univariate_continuous_parameters <- data.frame(matrix(NA,ncol=7,nrow=2,dimnames=list(c(),c("output_dir","note","data","vars","group_var","nums","type"))),stringsAsFactors=FALSE)
univariate_continuous_parameters[1,] <- c(output_directory_univariate_continuous,"continuous","data_all_univariate_continuous","XXX","yr_month",univariate_continuous_quantiles,"year")
univariate_continuous_parameters[2,] <- c(output_directory_univariate_continuous,"continuous","data_all_univariate_continuous","XXX","yr_month",univariate_continuous_quantiles,"agg")
univariate_continuous_year_groups <- data.frame(matrix(NA,ncol=2,nrow=1,dimnames=list(c(),c("Start_yr","End_yr"))),stringsAsFactors=FALSE)
univariate_continuous_year_groups[1,] <- c(start_year,end_year)
a_ply(.data=univariate_continuous_parameters,.margins=1,.fun = function(x,vars_dep,vars_indep,identifier,year_groups){
# x <- univariate_continuous_parameters[1,]
# x <- univariate_continuous_parameters[2,]
# vars_dep <- univariate_vars_dep
# vars_indep <- univariate_vars_continuous
# identifier <- identifier
# year_groups <- univariate_continuous_year_groups
l_ply(.data=vars_dep, .fun = function(y,dep_vars_all,x,vars_indep,identifier,year_groups){
# y <- vars_dep[[1]]
# dep_vars_all <- vars_dep
dep_var <- unlist(y)
cat("DEP VAR:",dep_var, "\n")
data <- get(x=unlist(x$data), envir = globalenv())
group_var <- x$group_var
univariate_vars_indep_continuous <- colnames(data)[!(colnames(data) %in% c("yr",group_var,y))]
quantile_var <- c("quantile_var_indep1","quantile_var_indep2")
quantiles_pct_flow  <- univariate_bins_continuous(data=data,dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var)
quantile_first_col <- "X1"
quantile_last_col <- paste("X",x$nums,sep="")
# Differences by group
range_str <- "yearly"
quantiles_pct_flow_diff_overall <- univariate_bins_diff(bins=quantiles_pct_flow,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var)
# Differences by year groups and group
a_ply(.data=year_groups, .margins=1, .fun = function(w,group_var,bins,quantile_first_col,quantile_last_col,dep_var,dep_vars_all,vars_indep,parameters,quantile_var){
# w <- year_groups[1,]
# group_var <- group_var
# bins <- quantiles_pct_flow
# parameters <- x
Start_yr <- w$Start_yr
End_yr <- w$End_yr
range_str <- paste(Start_yr,End_yr,sep="_")
if (group_var == "yr") {
bins_trim <- bins[(bins[,group_var]>=Start_yr & bins[,group_var]<=End_yr),]
} else if (group_var == "yr_month") {
bins_trim <- bins[(as.integer(substr(as.character(bins[,group_var]),1,4))>=Start_yr & as.integer(substr(as.character(bins[,group_var]),1,4))<=End_yr),]
} else {
cat("ERROR IN GROUPS", "\n")
}
bins_trim[,group_var] <- 9999
quantiles_pct_flow_diff_group  <- univariate_bins_diff(bins=bins_trim,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=vars_indep,parameters=parameters,quantile_var=quantile_var)
}, group_var=group_var,bins=quantiles_pct_flow,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var,
.expand = TRUE, .progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
rm(dep_var,data,group_var,univariate_vars_indep_continuous,quantile_var,quantiles_pct_flow)
rm(quantile_first_col,quantile_last_col,range_str,quantiles_pct_flow_diff_overall)
}, x=x, dep_vars_all=vars_dep,vars_indep=vars_indep,identifier=identifier, year_groups=year_groups,
.progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
},vars_dep=univariate_vars_dep,vars_indep=univariate_vars_continuous,identifier=identifier,year_groups=univariate_continuous_year_groups,.progress = "none")
rm2(output_directory_univariate_continuous,univariate_continuous_quantiles,univariate_continuous_parameters)
###############################################################################
cat("UNIVARIATE ANALYSIS - BINARY", "\n")
###############################################################################
output_directory_univariate_binary <- paste(output_directory,"univariate_binary","\\",sep="")
create_directory(output_directory_univariate_binary,remove=1)
data_all_univariate_binary <- data_all[,c("yr","yr_month",univariate_vars_dep,univariate_vars_binary)]
univariate_binary_quantiles <- 2
univariate_binary_parameters <- data.frame(matrix(NA,ncol=7,nrow=2,dimnames=list(c(),c("output_dir","note","data","vars","group_var","nums","type"))),stringsAsFactors=FALSE)
univariate_binary_parameters[1,] <- c(output_directory_univariate_binary,"binary","data_all_univariate_binary","XXX","yr_month",univariate_binary_quantiles,"year")
univariate_binary_parameters[2,] <- c(output_directory_univariate_binary,"binary","data_all_univariate_binary","XXX","yr_month",univariate_binary_quantiles,"agg")
univariate_binary_year_groups <- data.frame(matrix(NA,ncol=2,nrow=1,dimnames=list(c(),c("Start_yr","End_yr"))),stringsAsFactors=FALSE)
#univariate_binary_year_groups[1,] <- c(start_year,end_year)
univariate_binary_year_groups[1,] <- c(2007,end_year)
a_ply(.data=univariate_binary_parameters,.margins=1,.fun = function(x,vars_dep,vars_indep,identifier,year_groups){
# x <- univariate_binary_parameters[1,]
# x <- univariate_binary_parameters[2,]
# vars_dep <- univariate_vars_dep
# vars_indep <- univariate_vars_binary
# identifier <- identifier
# year_groups <- univariate_binary_year_groups
l_ply(.data=vars_dep, .fun = function(y,dep_vars_all,x,vars_indep,identifier,year_groups){
# y <- vars_dep[[1]]
# dep_vars_all <- vars_dep
dep_var <- unlist(y)
cat("DEP VAR:",dep_var, "\n")
data <- get(x=unlist(x$data), envir = globalenv())
group_var <- x$group_var
univariate_vars_indep_binary <- colnames(data)[!(colnames(data) %in% c("yr",group_var,dep_vars_all))]
quantile_var <- c("quantile_var_indep1","quantile_var_indep2")
quantiles_pct_flow  <- univariate_bins_binary(data=data,dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_binary,parameters=x,quantile_var=quantile_var)
quantile_first_col <- "X0"
quantile_last_col <- paste("X",(as.integer(x$nums)-1),sep="")
# Differences by group
range_str <- "yearly"
quantiles_pct_flow_diff_overall <- univariate_bins_diff(bins=quantiles_pct_flow,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_binary,parameters=x,quantile_var=quantile_var)
# Differences by year groups and group
a_ply(.data=year_groups, .margins=1, .fun = function(w,group_var,bins,quantile_first_col,quantile_last_col,dep_var,dep_vars_all,vars_indep,parameters,quantile_var){
# w <- year_groups[1,]
# group_var <- group_var
# bins <- quantiles_pct_flow
# parameters <- x
Start_yr <- w$Start_yr
End_yr <- w$End_yr
range_str <- paste(Start_yr,End_yr,sep="_")
if (group_var == "yr") {
bins_trim <- bins[(bins[,group_var]>=Start_yr & bins[,group_var]<=End_yr),]
} else if (group_var == "yr_month") {
bins_trim <- bins[(as.integer(substr(as.character(bins[,group_var]),1,4))>=Start_yr & as.integer(substr(as.character(bins[,group_var]),1,4))<=End_yr),]
} else {
cat("ERROR IN GROUPS", "\n")
}
bins_trim[,group_var] <- 9999
quantiles_pct_flow_diff_group  <- univariate_bins_diff(bins=bins_trim,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=vars_indep,parameters=parameters,quantile_var=quantile_var)
}, group_var=group_var,bins=quantiles_pct_flow,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_binary,parameters=x,quantile_var=quantile_var,
.expand = TRUE, .progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
rm(dep_var,data,group_var,univariate_vars_indep_binary,quantile_var,quantiles_pct_flow)
rm(quantile_first_col,quantile_last_col,range_str,quantiles_pct_flow_diff_overall)
}, x=x, dep_vars_all=vars_dep,vars_indep=vars_indep,identifier=identifier, year_groups=year_groups,
.progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
},vars_dep=univariate_vars_dep,vars_indep=univariate_vars_binary,identifier=identifier,year_groups=univariate_binary_year_groups,.progress = "none")
rm2(output_directory_univariate_binary,univariate_binary_quantiles,univariate_binary_parameters)
###############################################################################
cat("UNIVARIATE ANALYSIS - QUALITY SCORE", "\n")
###############################################################################
univariate_vars_manual <- univariate_vars_continuous_pattern
output_directory_univariate_manual <- paste(output_directory,"univariate_manual","\\",sep="")
create_directory(output_directory_univariate_manual,remove=1)
data_all_univariate_manual <- data_all[,c("yr","yr_month",univariate_vars_dep,univariate_vars_continuous_pattern)]
univariate_manual_quantiles <- 4
univariate_manual_parameters <- data.frame(matrix(NA,ncol=7,nrow=2,dimnames=list(c(),c("output_dir","note","data","vars","group_var","nums","type"))),stringsAsFactors=FALSE)
univariate_manual_parameters[1,] <- c(output_directory_univariate_manual,"manual","data_all_univariate_manual","XXX","yr_month",univariate_manual_quantiles,"year")
univariate_manual_parameters[2,] <- c(output_directory_univariate_manual,"manual","data_all_univariate_manual","XXX","yr_month",univariate_manual_quantiles,"agg")
univariate_manual_year_groups <- data.frame(matrix(NA,ncol=2,nrow=1,dimnames=list(c(),c("Start_yr","End_yr"))),stringsAsFactors=FALSE)
#univariate_manual_year_groups[1,] <- c(start_year,end_year)
univariate_manual_year_groups[1,] <- c(2007,end_year)
#max(data_all[,"quality_score_trim2_90"])
#min(data_all[,"quality_score_trim2_90"])
#mean(data_all[,"quality_score_trim2_90"])
#median(data_all[,"quality_score_trim2_90"])
#t(quantile(data_all[,"quality_score_trim2_90"],c(0.01,0.05, 0.10, 0.25, 0.50, 0.75, 0.90, 0.95,0.99)))
#t(quantile(data_all[,"quality_score_trim2_90"],seq(.01,1,.01)))
univariate_manual_breaks <- data.frame(matrix(NA,ncol=3,nrow=length(univariate_vars_manual)*univariate_manual_quantiles,dimnames=list(c(),c("indep_var","start_break","end_break"))),stringsAsFactors=FALSE)
univariate_manual_breaks[1,] <- c(univariate_vars_manual[1],0,1)
univariate_manual_breaks[2,] <- c(univariate_vars_manual[1],2,2)
univariate_manual_breaks[3,] <- c(univariate_vars_manual[1],3,3)
univariate_manual_breaks[4,] <- c(univariate_vars_manual[1],4,7)
a_ply(.data=univariate_manual_parameters,.margins=1,.fun = function(x,vars_dep,vars_indep,identifier,year_groups,breaks){
# x <- univariate_manual_parameters[1,]
# x <- univariate_manual_parameters[2,]
# vars_dep <- univariate_vars_dep
# vars_indep <- univariate_vars_manual
# identifier <- identifier
# year_groups <- univariate_manual_year_groups
# breaks <- univariate_manual_breaks
l_ply(.data=vars_dep, .fun = function(y,dep_vars_all,x,vars_indep,identifier,year_groups,breaks){
# y <- vars_dep[[1]]
# dep_vars_all <- vars_dep
dep_var <- unlist(y)
cat("DEP VAR:",dep_var, "\n")
data <- get(x=unlist(x$data), envir = globalenv())
group_var <- x$group_var
#univariate_vars_indep_manual <- colnames(data)[!(colnames(data) %in% c("yr",group_var,y))]
univariate_vars_indep_manual <- colnames(data)[!(colnames(data) %in% c("yr",group_var,dep_vars_all))]
quantile_var <- c("quantile_var_indep1","quantile_var_indep2")
quantiles_pct_flow  <- univariate_bins_manual(data=data,dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_manual,parameters=x,quantile_var=quantile_var,breaks=breaks)
quantile_first_col <- "X1"
quantile_last_col <- paste("X",x$nums,sep="")
# Differences by group
range_str <- "yearly"
quantiles_pct_flow_diff_overall <- univariate_bins_diff(bins=quantiles_pct_flow,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_manual,parameters=x,quantile_var=quantile_var)
# Differences by year groups and group
a_ply(.data=year_groups, .margins=1, .fun = function(w,group_var,bins,quantile_first_col,quantile_last_col,dep_var,dep_vars_all,vars_indep,parameters,quantile_var){
# w <- year_groups[1,]
# group_var <- group_var
# bins <- quantiles_pct_flow
# parameters <- x
Start_yr <- w$Start_yr
End_yr <- w$End_yr
range_str <- paste(Start_yr,End_yr,sep="_")
if (group_var == "yr") {
bins_trim <- bins[(bins[,group_var]>=Start_yr & bins[,group_var]<=End_yr),]
} else if (group_var == "yr_month") {
bins_trim <- bins[(as.integer(substr(as.character(bins[,group_var]),1,4))>=Start_yr & as.integer(substr(as.character(bins[,group_var]),1,4))<=End_yr),]
} else {
cat("ERROR IN GROUPS", "\n")
}
bins_trim[,group_var] <- 9999
quantiles_pct_flow_diff_group  <- univariate_bins_diff(bins=bins_trim,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=vars_indep,parameters=parameters,quantile_var=quantile_var)
}, group_var=group_var,bins=quantiles_pct_flow,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_manual,parameters=x,quantile_var=quantile_var,
.expand = TRUE, .progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
rm(dep_var,data,group_var,univariate_vars_indep_manual,quantile_var,quantiles_pct_flow)
rm(quantile_first_col,quantile_last_col,range_str,quantiles_pct_flow_diff_overall)
}, x=x, dep_vars_all=vars_dep,vars_indep=vars_indep,identifier=identifier, year_groups=year_groups,breaks=breaks,
.progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
},vars_dep=univariate_vars_dep,vars_indep=univariate_vars_manual,identifier=identifier,year_groups=univariate_manual_year_groups,breaks=univariate_manual_breaks,.progress = "none")
rm2(output_directory_univariate_manual,univariate_manual_quantiles,univariate_manual_parameters)
output_directory_univariate_continuous <- paste(output_directory,"univariate_continuous","\\",sep="")
create_directory(output_directory_univariate_continuous,remove=1)
data_all_univariate_continuous <- data_all[,c("yr","yr_month",univariate_vars_dep,univariate_vars_continuous)]
univariate_continuous_quantiles <- 4
univariate_continuous_parameters <- data.frame(matrix(NA,ncol=7,nrow=2,dimnames=list(c(),c("output_dir","note","data","vars","group_var","nums","type"))),stringsAsFactors=FALSE)
univariate_continuous_parameters[1,] <- c(output_directory_univariate_continuous,"continuous","data_all_univariate_continuous","XXX","yr_month",univariate_continuous_quantiles,"year")
univariate_continuous_parameters[2,] <- c(output_directory_univariate_continuous,"continuous","data_all_univariate_continuous","XXX","yr_month",univariate_continuous_quantiles,"agg")
univariate_continuous_year_groups <- data.frame(matrix(NA,ncol=2,nrow=1,dimnames=list(c(),c("Start_yr","End_yr"))),stringsAsFactors=FALSE)
#univariate_continuous_year_groups[1,] <- c(start_year,end_year)
univariate_continuous_year_groups[1,] <- c(2007,end_year)
a_ply(.data=univariate_continuous_parameters,.margins=1,.fun = function(x,vars_dep,vars_indep,identifier,year_groups){
# x <- univariate_continuous_parameters[1,]
# x <- univariate_continuous_parameters[2,]
# vars_dep <- univariate_vars_dep
# vars_indep <- univariate_vars_continuous
# identifier <- identifier
# year_groups <- univariate_continuous_year_groups
l_ply(.data=vars_dep, .fun = function(y,dep_vars_all,x,vars_indep,identifier,year_groups){
# y <- vars_dep[[1]]
# dep_vars_all <- vars_dep
dep_var <- unlist(y)
cat("DEP VAR:",dep_var, "\n")
data <- get(x=unlist(x$data), envir = globalenv())
group_var <- x$group_var
univariate_vars_indep_continuous <- colnames(data)[!(colnames(data) %in% c("yr",group_var,y))]
quantile_var <- c("quantile_var_indep1","quantile_var_indep2")
quantiles_pct_flow  <- univariate_bins_continuous(data=data,dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var)
quantile_first_col <- "X1"
quantile_last_col <- paste("X",x$nums,sep="")
# Differences by group
range_str <- "yearly"
quantiles_pct_flow_diff_overall <- univariate_bins_diff(bins=quantiles_pct_flow,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var)
# Differences by year groups and group
a_ply(.data=year_groups, .margins=1, .fun = function(w,group_var,bins,quantile_first_col,quantile_last_col,dep_var,dep_vars_all,vars_indep,parameters,quantile_var){
# w <- year_groups[1,]
# group_var <- group_var
# bins <- quantiles_pct_flow
# parameters <- x
Start_yr <- w$Start_yr
End_yr <- w$End_yr
range_str <- paste(Start_yr,End_yr,sep="_")
if (group_var == "yr") {
bins_trim <- bins[(bins[,group_var]>=Start_yr & bins[,group_var]<=End_yr),]
} else if (group_var == "yr_month") {
bins_trim <- bins[(as.integer(substr(as.character(bins[,group_var]),1,4))>=Start_yr & as.integer(substr(as.character(bins[,group_var]),1,4))<=End_yr),]
} else {
cat("ERROR IN GROUPS", "\n")
}
bins_trim[,group_var] <- 9999
quantiles_pct_flow_diff_group  <- univariate_bins_diff(bins=bins_trim,range_str=range_str,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=vars_indep,parameters=parameters,quantile_var=quantile_var)
}, group_var=group_var,bins=quantiles_pct_flow,quantile_first_col=quantile_first_col,quantile_last_col=quantile_last_col,
dep_var=dep_var,dep_vars_all=dep_vars_all,vars_indep=univariate_vars_indep_continuous,parameters=x,quantile_var=quantile_var,
.expand = TRUE, .progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
rm(dep_var,data,group_var,univariate_vars_indep_continuous,quantile_var,quantiles_pct_flow)
rm(quantile_first_col,quantile_last_col,range_str,quantiles_pct_flow_diff_overall)
}, x=x, dep_vars_all=vars_dep,vars_indep=vars_indep,identifier=identifier, year_groups=year_groups,
.progress = "none", .inform = FALSE, .print = FALSE, .parallel = FALSE, .paropts = NULL)
},vars_dep=univariate_vars_dep,vars_indep=univariate_vars_continuous,identifier=identifier,year_groups=univariate_continuous_year_groups,.progress = "none")
