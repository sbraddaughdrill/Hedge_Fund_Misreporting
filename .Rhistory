{
#i <- 1
#i <- 2
#data_all[,winsorize_vars[i]] <- winsorize_both(data_all[,winsorize_vars[i]],q=0.025)
data_all[,winsorize_vars[i]] <- winsorize_both(data_all[,winsorize_vars[i]],q=0.005)
}
rm(i)
rm2(winsorize_vars)
###############################################################################
cat("MULTIVARIATE ANALYSIS - VARIABLES","\n")
###############################################################################
pattern_cols_sub <- c("per_positive_percent","num_zero_percent","per_repeats_percent","uniform_percent",
"string_percent","num_pairs_percent","per_negative_percent","ar_1_percent","indexrsq_percent",
"kink_percent","quality_score_trim0","quality_score_trim1","quality_score_trim2","quality_score_trim3")
pattern_cols_all <- unique(unlist(lapply(pattern_cols_sub,function(x,cols){cols[grep(x,cols)]},cols=colnames(data_all))))
### All pattern cols
pattern_cols_99 <- pattern_cols_all[grep("_99_",pattern_cols_all)]
pattern_cols_99_any <- pattern_cols_99[grep("_any_",pattern_cols_99)]
pattern_cols_99_avg <- pattern_cols_99[grep("_avg_",pattern_cols_99)]
pattern_cols_95 <- pattern_cols_all[grep("_95_",pattern_cols_all)]
pattern_cols_95_any <- pattern_cols_95[grep("_any_",pattern_cols_95)]
pattern_cols_95_avg <- pattern_cols_95[grep("_avg_",pattern_cols_95)]
pattern_cols_90 <- pattern_cols_all[grep("_90_",pattern_cols_all)]
pattern_cols_90_any <- pattern_cols_90[grep("_any_",pattern_cols_90)]
pattern_cols_90_avg <- pattern_cols_90[grep("_avg_",pattern_cols_90)]
pattern_cols <- c(pattern_cols_99_any,pattern_cols_99_avg,pattern_cols_95_any,pattern_cols_95_avg,pattern_cols_90_any,pattern_cols_90_avg)
### Quaity Score cols
quality_score_cols_trim0 <- pattern_cols_all[grep("quality_score_trim0",pattern_cols_all)]
quality_score_cols_trim1 <- pattern_cols_all[grep("quality_score_trim1",pattern_cols_all)]
quality_score_cols_trim2 <- pattern_cols_all[grep("quality_score_trim2",pattern_cols_all)]
quality_score_cols_trim3 <- pattern_cols_all[grep("quality_score_trim3",pattern_cols_all)]
#quality_score_cols <- c(quality_score_cols_trim0,quality_score_cols_trim1,quality_score_cols_trim2,quality_score_cols_trim3)
quality_score_cols <- c(quality_score_cols_trim0,quality_score_cols_trim1)
### Revision cols
revision_cols <- c("Revision_DV","Revision_1BP_DV","Revision_10BP_DV","Revision_50BP_DV","Revision_100BP_DV")
### Dep Vars (Text Vars)
multivariate_vars_dep <- c(pattern_cols,revision_cols)
### Continuous Vars
multivariate_vars_continuous_fund <- c("pflow","sdpct_flow","sdpct_flow_lag1",
"Yearly_Ret2","Yearly_Ret2_lag1","Yearly_Ret2_sq","Yearly_Ret2_sq_lag1",
"mktadjret","mktadjret_lag1",
"mktadjret_sq","mktadjret_sq_lag1",
"AUM","AUM_lag1","AUM_log","AUM_log_lag1",
"Fund_Size_USm","Fund_Capacity_USm","Firms_Total_Asset_USm","Total_Asset_in_Hedge_Funds_USm",
"age_y","age_m","Sharpe_Ratio","Sortino_Ratio",
"total_fee","Management_Fee_bin","Performance_Fee_bin","Other_Fee_bin")
#"pflow_lag1","pflow_lag2","pflow_lag3","pflow_lag4",
#"mktadjret_lag1","mktadjret_lag2","mktadjret_lag3","mktadjret_lag4",
#"mktadjret_sq_lag1","mktadjret_sq_lag2","mktadjret_sq_lag3","mktadjret_sq_lag4",
#"AUM_log_lag1","AUM_log_lag2","AUM_log_lag3","AUM_log_lag4",
multivariate_vars_continuous_text <- c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios",
"avg_grade_level_ios","avg_grade_level_ac_ios","avg_grade_level_acf_ios",
"chars_no_space_ios","words_ios","sentences_ios",
"all_similarity_050pct_ios","Primary_Investment_Strategy_combcol_similarity_050pct_ios",
"all_similarity_100pct_ios","Primary_Investment_Strategy_combcol_similarity_100pct_ios",
"all_similarity_250pct_ios","Primary_Investment_Strategy_combcol_similarity_250pct_ios",
"all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios",
"all_similarity_750pct_ios","Primary_Investment_Strategy_combcol_similarity_750pct_ios",
"all_similarity_900pct_ios","Primary_Investment_Strategy_combcol_similarity_900pct_ios")
multivariate_vars_continuous_tone <- c("per_litigious","per_modalstrong","per_modalweak","per_negative","per_positive","per_uncertainty")
multivariate_vars_continuous <- c(multivariate_vars_continuous_fund,multivariate_vars_continuous_text,multivariate_vars_continuous_tone)
### Binary Vars
multivariate_vars_binary_fund <- c("Listed_on_Exchange_bin","Hurdle_Rate_bin","Domicile_onshore_bin","Leverage_bin","Lockup_bin",
"Flagship_bin","Closed_bin","Dead_bin")
multivariate_vars_binary_tone <- c("litigious_dv","modalstrong_dv","modalweak_dv","negative_dv","positive_dv","uncertainty_dv")
multivariate_vars_binary <- c(multivariate_vars_binary_fund,multivariate_vars_binary_tone)
rm2(quality_score_cols_trim0,quality_score_cols_trim1,quality_score_cols_trim2,quality_score_cols_trim3)
rm2(pattern_cols_99,pattern_cols_99_any,pattern_cols_99_avg)
rm2(pattern_cols_95,pattern_cols_95_any,pattern_cols_95_avg)
rm2(pattern_cols_90,pattern_cols_90_any,pattern_cols_90_avg)
rm2(pattern_cols_sub,pattern_cols_all)
#rm2(pattern_cols,revision_cols)
###############################################################################
cat("ADD NEW COLUMNS","\n")
###############################################################################
data_all_multivariate_new_cols <- c("age_y_log","age_m_log","AUM_USm","AUM_USm_log","Fund_Size_USm_log","Fund_Capacity_USm_log","Fund_Utilization_Ratio",
"Firm_Size_combcol","Firm_Size_combcol_log","Fund_to_Firm_Size",paste(strat_col,"2",sep=""))
#data_all_multivariate_full_keep_trim0 <- data.frame(unique(data_all[,c(identifier,"yr",multivariate_vars_dep,multivariate_vars_continuous)]),
#                                                    matrix(NA,ncol=length(data_all_multivariate_new_cols),nrow=1,dimnames=list(c(),data_all_multivariate_new_cols)),stringsAsFactors=F)
data_all_multivariate_full_keep_trim0 <- data.frame(unique(data_all[,colnames(data_all)[colnames(data_all) %in% c(identifier,"Fund_Name","Strategy","yr",strat_col,multivariate_vars_dep,multivariate_vars_continuous,multivariate_vars_binary)]]),
matrix(NA,ncol=length(data_all_multivariate_new_cols),nrow=1,dimnames=list(c(),data_all_multivariate_new_cols)),
#matrix(NA,ncol=length(quality_score_cols),nrow=1,dimnames=list(c(),paste(quality_score_cols,"rv",sep="_"))),
stringsAsFactors=F)
data_all_multivariate_full_keep_trim0[,"age_m"] <- data_all_multivariate_full_keep_trim0[,"age_m"]+1
data_all_multivariate_full_keep_trim0[,"age_m_log"] <- log(data_all_multivariate_full_keep_trim0[,"age_m"])
data_all_multivariate_full_keep_trim0[,"age_y"] <- data_all_multivariate_full_keep_trim0[,"age_m"]/12
data_all_multivariate_full_keep_trim0[,"age_y_log"] <- log(data_all_multivariate_full_keep_trim0[,"age_y"])
data_all_multivariate_full_keep_trim0[,"AUM_USm"] <- data_all_multivariate_full_keep_trim0[,"AUM"]/1000000
data_all_multivariate_full_keep_trim0[,"AUM_USm_log"] <- log(data_all_multivariate_full_keep_trim0[,"AUM_USm"])
data_all_multivariate_full_keep_trim0[,"Fund_Size_USm_log"] <- log(data_all_multivariate_full_keep_trim0[,"Fund_Size_USm"])
data_all_multivariate_full_keep_trim0[,"Fund_Capacity_USm_log"] <- log(data_all_multivariate_full_keep_trim0[,"Fund_Capacity_USm"])
data_all_multivariate_full_keep_trim0[,"Fund_Utilization_Ratio"] <- data_all_multivariate_full_keep_trim0[,"Fund_Size_USm"]/data_all_multivariate_full_keep_trim0[,"Fund_Capacity_USm"]
data_all_multivariate_full_keep_trim0[,"Firm_Size_combcol"] <- ifelse((is.na(data_all_multivariate_full_keep_trim0[,"Firms_Total_Asset_USm"]) & is.na(data_all_multivariate_full_keep_trim0[,"Total_Asset_in_Hedge_Funds_USm"])),NA,
ifelse((!is.na(data_all_multivariate_full_keep_trim0[,"Firms_Total_Asset_USm"]) & is.na(data_all_multivariate_full_keep_trim0[,"Total_Asset_in_Hedge_Funds_USm"])),data_all_multivariate_full_keep_trim0[,"Firms_Total_Asset_USm"],
ifelse((is.na(data_all_multivariate_full_keep_trim0[,"Firms_Total_Asset_USm"]) & !is.na(data_all_multivariate_full_keep_trim0[,"Total_Asset_in_Hedge_Funds_USm"])),data_all_multivariate_full_keep_trim0[,"Total_Asset_in_Hedge_Funds_USm"],data_all_multivariate_full_keep_trim0[,"Firms_Total_Asset_USm"])))
data_all_multivariate_full_keep_trim0[,"Firm_Size_combcol_log"] <- log(data_all_multivariate_full_keep_trim0[,"Firm_Size_combcol"])
data_all_multivariate_full_keep_trim0[,"Fund_to_Firm_Size"] <- data_all_multivariate_full_keep_trim0[,"Fund_Size_USm"]/data_all_multivariate_full_keep_trim0[,"Firm_Size_combcol"]
data_all_multivariate_full_keep_trim0[,paste(strat_col,"2",sep="")] <- ifelse(data_all_multivariate_full_keep_trim0[,strat_col] %in% c("ARBITRAGE","DEBT","DUAL APPROACH","EVENT DRIVEN","TOP DOWN","VALUE","OTHERS"),"OTHER2",data_all_multivariate_full_keep_trim0[,strat_col])
for (i in which(colnames(data_all_multivariate_full_keep_trim0) %in% multivariate_vars_binary))
{
#i <- 1
#i <- 2
data_all_multivariate_full_keep_trim0[[i]] <- ifelse(is.na(data_all_multivariate_full_keep_trim0[[i]]),0,data_all_multivariate_full_keep_trim0[[i]])
}
rm(i)
for (i in which(colnames(data_all_multivariate_full_keep_trim0) %in% revision_cols))
{
#i <- 1
#i <- 2
data_all_multivariate_full_keep_trim0[[i]] <- ifelse(is.na(data_all_multivariate_full_keep_trim0[[i]]),0,data_all_multivariate_full_keep_trim0[[i]])
}
rm(i)
data_all_multivariate_full_keep_trim <- data_all_multivariate_full_keep_trim0
rm2(data_all_multivariate_new_cols,data_all_multivariate_full_keep_trim0)
###############################################################################
cat("FIND FIRST YEAR FOR EACH FUND","\n")
###############################################################################
#data_all_multivariate_lookup0 <- data_all[!is.na(data_all[,strat_col]),]
data_all_multivariate_lookup0 <- data_all[(!is.na(data_all[,strat_col]) & !is.na(data_all[,"AUM"]) & !is.na(data_all[,"age_y"]) & !is.na(data_all[,"total_fee"])),]
data_all_multivariate_lookup1 <- unique(data_all_multivariate_lookup0[,c(identifier,"yr")])
data_all_multivariate_lookup1 <- data_all_multivariate_lookup1[order(data_all_multivariate_lookup1[,identifier],data_all_multivariate_lookup1[,"yr"]),]
row.names(data_all_multivariate_lookup1) <- seq(nrow(data_all_multivariate_lookup1))
data_all_multivariate_lookup <- data_all_multivariate_lookup1
data_all_multivariate_lookup <- as.data.table(data_all_multivariate_lookup)
setkeyv(data_all_multivariate_lookup,c(identifier,"yr"))
setorderv(data_all_multivariate_lookup,c(identifier,"yr"),c(1,1))
data_all_multivariate_lookup <- data_all_multivariate_lookup[,.SD[c(1)],by=c(identifier)]
data_all_multivariate_lookup <- as.data.frame(data_all_multivariate_lookup,stringsAsFactors=F)
rm2(data_all_multivariate_lookup0,data_all_multivariate_lookup1)
data_all_multivariate_full1 <- merge(data_all_multivariate_lookup,data_all_multivariate_full_keep_trim,
by.x=c(identifier,"yr"),by.y=c(identifier,"yr"),
all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_all_multivariate_full1 <- data_all_multivariate_full1[order(data_all_multivariate_full1[,identifier],data_all_multivariate_full1[,"yr"]),]
row.names(data_all_multivariate_full1) <- seq(nrow(data_all_multivariate_full1))
rm2(data_all_multivariate_lookup,data_all_multivariate_full_keep_trim)
data_all_multivariate_full2 <- as.data.table(data_all_multivariate_full1)
setkeyv(data_all_multivariate_full2,c(identifier,"yr"))
setorderv(data_all_multivariate_full2,c(identifier,"yr"),c(1,1))
data_all_multivariate_full2 <- data_all_multivariate_full2[!is.na(Primary_Investment_Strategy_combcol)]
data_all_multivariate_full2 <- data_all_multivariate_full2[!is.na(AUM)]
data_all_multivariate_full2 <- data_all_multivariate_full2[!is.na(age_y)]
data_all_multivariate_full2 <- data_all_multivariate_full2[!is.na(total_fee)]
data_all_multivariate_full2[,na_count:=rowSums(is.na(.SD)),.SDcols=colnames(data_all_multivariate_full2)]
setorderv(data_all_multivariate_full2,c(identifier,"yr","na_count"),c(1,1,1))
data_all_multivariate_full2[,na_count:=NULL,by=NULL]
setkeyv(data_all_multivariate_full2,c(identifier,"yr"))
data_all_multivariate_full2 <- data_all_multivariate_full2[,.SD[c(1)],by=c(identifier,"yr")]
data_all_multivariate_full <- as.data.frame(data_all_multivariate_full2,stringsAsFactors=F)
rm2(data_all_multivariate_full1,data_all_multivariate_full2)
###############################################################################
cat("FIND FUNDS WITH SAME TEXT MEASURES","\n")
###############################################################################
data_all_multivariate_full_trim <- data_all_multivariate_full
data_all_multivariate_full_trim <- data_all_multivariate_full_trim[!(data_all_multivariate_full_trim[,identifier] %in% c(38679,38680)),]
rm2(data_all_multivariate_full)
###############################################################################
cat("FIND TOP-3 FOR EACH TEXT MEASURE - SETUP","\n")
###############################################################################
data_all_multivariate_full_cols_id <- c(identifier,"Fund_Name","Strategy")
data_all_multivariate_full_cols_nonid <- c("quality_score_trim1_90_any_024","quality_score_trim1_90_avg_024",
"ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios","avg_grade_level_ios","words_ios",
"all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios",multivariate_vars_continuous_tone)
data_summary_rank_lookup <- data_all_multivariate_full_trim[,c(identifier,"Fund_Name","yr")]
top_bot_out_path <- paste(output_directory,"Top_Bottom_Stats",sep="//",collapse="//")
create_directory(top_bot_out_path,remove=1)
###############################################################################
cat("FIND TOP-3 FOR EACH TEXT MEASURE - WINSORIZE","\n")
###############################################################################
data_summary_rank_winsorize <- merge(data_summary_rank_lookup,data_all_multivariate_full_trim[,c(data_all_multivariate_full_cols_id,"yr",data_all_multivariate_full_cols_nonid)],
by.x=c(identifier,"yr","Fund_Name"),by.y=c(identifier,"yr","Fund_Name"),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize <- data_summary_rank_winsorize[order(data_summary_rank_winsorize[,identifier]),]
row.names(data_summary_rank_winsorize) <- seq(nrow(data_summary_rank_winsorize))
data_summary_rank_winsorize <- data.frame(data_summary_rank_winsorize,
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"rank",sep="_"))),
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"top3",sep="_"))),
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"bot3",sep="_"))),
stringsAsFactors=F)
data_summary_rank_winsorize_trim0 <- ldply(.data=data_all_multivariate_full_cols_nonid,.fun=function(x,data,id_cols){
# x <- data_all_multivariate_full_cols_nonid[[1]]
# data <- data_summary_rank_winsorize
# id_cols <- data_all_multivariate_full_cols_id
#cat(data_all_multivariate_full_cols_nonid[[i]], "\n")
temp_var <- unlist(x)
temp_vector <- data.frame(temp_col=sort(unique(data[,temp_var])),matrix(NA,ncol=3,nrow=1,dimnames=list(c(),c("temp_rank","temp_top3","temp_bot3"))),stringsAsFactors=F)
temp_vector[,"temp_rank"] <- seq(1,nrow(temp_vector))
temp_vector[,"temp_top3"] <-ifelse(temp_vector[,"temp_rank"] %in% tail(temp_vector[,"temp_rank"],3),temp_vector[,"temp_rank"],0)
temp_vector[,"temp_bot3"] <-ifelse(temp_vector[,"temp_rank"] %in% head(temp_vector[,"temp_rank"],3),temp_vector[,"temp_rank"],0)
temp_vector <- temp_vector[order(-temp_vector[,"temp_top3"]),]
temp_vector[,"temp_top3"] <- c("T1","T2","T3",rep(NA,nrow(temp_vector)-3))
temp_vector <- temp_vector[order(-temp_vector[,"temp_bot3"]),]
temp_vector[,"temp_bot3"] <- c("B3","B2","B1",rep(NA,nrow(temp_vector)-3))
temp_vector[,"temp_rank"] <- ifelse((is.na(temp_vector[,"temp_top3"]) & is.na(temp_vector[,"temp_bot3"])),NA,
ifelse((!is.na(temp_vector[,"temp_top3"]) & is.na(temp_vector[,"temp_bot3"])),temp_vector[,"temp_top3"],
ifelse((is.na(temp_vector[,"temp_top3"]) & !is.na(temp_vector[,"temp_bot3"])),temp_vector[,"temp_bot3"],
paste(temp_vector[,"temp_top3"],temp_vector[,"temp_bot3"],sep=","))))
colnames(temp_vector)[match("temp_col",names(temp_vector))] <- temp_var
colnames(temp_vector)[match("temp_rank",names(temp_vector))] <- paste(temp_var,"rank",sep="_")
colnames(temp_vector)[match("temp_top3",names(temp_vector))] <- paste(temp_var,"top3",sep="_")
colnames(temp_vector)[match("temp_bot3",names(temp_vector))] <- paste(temp_var,"bot3",sep="_")
data <- merge(data[,!(colnames(data) %in% paste(temp_var,c("rank","top3","bot3"),sep="_"))],temp_vector,
by.x=temp_var,by.y=temp_var,all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data <- data[order(data[,identifier]),]
row.names(data) <- seq(nrow(data))
data <- data[,c(id_cols,colnames(data)[!(colnames(data) %in% id_cols)])]
data <- data[,c(colnames(data)[!(colnames(data) %in% c(temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_")))],
c(temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_")))]
data_trim <- data.frame(var_name=NA,data[,c(id_cols,temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_"))],stringsAsFactors=F)
colnames(data_trim)[match(temp_var,names(data_trim))] <- "var_value"
colnames(data_trim)[match(paste(temp_var,"rank",sep="_"),names(data_trim))] <- "rank"
colnames(data_trim)[match(paste(temp_var,"top3",sep="_"),names(data_trim))] <- "top3"
colnames(data_trim)[match(paste(temp_var,"bot3",sep="_"),names(data_trim))] <- "bot3"
data_trim[,"var_name"] <- temp_var
data_trim <- data_trim[,c(id_cols,colnames(data_trim)[!(colnames(data_trim) %in% id_cols)])]
rm(temp_var,temp_vector)
return(data_trim)
},data=data_summary_rank_winsorize,id_cols=data_all_multivariate_full_cols_id,.progress="none",.inform=F)
data_summary_rank_winsorize_trim1 <- data_summary_rank_winsorize_trim0[,colnames(data_summary_rank_winsorize_trim0)[!(colnames(data_summary_rank_winsorize_trim0) %in% c("top3","bot3"))]]
data_summary_rank_winsorize_trim2 <- data_summary_rank_winsorize_trim1[!(data_summary_rank_winsorize_trim1[,"var_name"] %in% c("quality_score_trim1_90_any_024","quality_score_trim1_90_avg_024","per_modalstrong","per_modalweak")),]
data_summary_rank_winsorize_trim3 <- data_summary_rank_winsorize_trim2[!((data_summary_rank_winsorize_trim2[,"var_name"] %in% c("per_litigious","per_negative","per_positive","per_uncertainty")) & (data_summary_rank_winsorize_trim2[,"var_value"]==0)),]
data_summary_rank_winsorize_trim4 <- data_summary_rank_winsorize_trim3[!is.na(data_summary_rank_winsorize_trim3[,"rank"]),]
rm(data_summary_rank_winsorize_trim0,data_summary_rank_winsorize_trim1,data_summary_rank_winsorize_trim2,data_summary_rank_winsorize_trim3)
## Readability
data_summary_rank_winsorize_readability_cast_data <- data_summary_rank_winsorize_trim4[data_summary_rank_winsorize_trim4[,"var_name"] %in% c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios","avg_grade_level_ios","words_ios"),]
data_summary_rank_winsorize_readability_cast0a <- unique(data_summary_rank_winsorize_readability_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_winsorize_readability_cast0b <- dcast(data=data_summary_rank_winsorize_readability_cast_data[,!(colnames(data_summary_rank_winsorize_readability_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_winsorize_readability_cast0c <- dcast(data=data_summary_rank_winsorize_readability_cast_data[,!(colnames(data_summary_rank_winsorize_readability_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_winsorize_readability_cast0c) <- paste(colnames(data_summary_rank_winsorize_readability_cast0c),"rank",sep="_")
colnames(data_summary_rank_winsorize_readability_cast0c)[1] <- identifier
data_summary_rank_winsorize_readability_cast1 <- merge(data_summary_rank_winsorize_readability_cast0a,data_summary_rank_winsorize_readability_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_readability_cast2 <- merge(data_summary_rank_winsorize_readability_cast1,data_summary_rank_winsorize_readability_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_readability_cast3 <- data_summary_rank_winsorize_readability_cast2[,sort(colnames(data_summary_rank_winsorize_readability_cast2))]
data_summary_rank_winsorize_readability_out <- data_summary_rank_winsorize_readability_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_winsorize_readability_cast3)[!(colnames(data_summary_rank_winsorize_readability_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_winsorize_readability_out <- data_summary_rank_winsorize_readability_out[order(data_summary_rank_winsorize_readability_out[,identifier]),]
row.names(data_summary_rank_winsorize_readability_out) <- seq(nrow(data_summary_rank_winsorize_readability_out))
write.csv(data_summary_rank_winsorize_readability_out,file=paste(top_bot_out_path,"//","Rank_Winsorize_Readability",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_winsorize_readability_cast_data)
rm2(data_summary_rank_winsorize_readability_cast0a,data_summary_rank_winsorize_readability_cast0b,data_summary_rank_winsorize_readability_cast0c)
rm2(data_summary_rank_winsorize_readability_cast1,data_summary_rank_winsorize_readability_cast2,data_summary_rank_winsorize_readability_cast3)
## Similarity
data_summary_rank_winsorize_similarity_cast_data <- data_summary_rank_winsorize_trim4[data_summary_rank_winsorize_trim4[,"var_name"] %in% c("all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios"),]
data_summary_rank_winsorize_similarity_cast0a <- unique(data_summary_rank_winsorize_similarity_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_winsorize_similarity_cast0b <- dcast(data=data_summary_rank_winsorize_similarity_cast_data[,!(colnames(data_summary_rank_winsorize_similarity_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_winsorize_similarity_cast0c <- dcast(data=data_summary_rank_winsorize_similarity_cast_data[,!(colnames(data_summary_rank_winsorize_similarity_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_winsorize_similarity_cast0c) <- paste(colnames(data_summary_rank_winsorize_similarity_cast0c),"rank",sep="_")
colnames(data_summary_rank_winsorize_similarity_cast0c)[1] <- identifier
data_summary_rank_winsorize_similarity_cast1 <- merge(data_summary_rank_winsorize_similarity_cast0a,data_summary_rank_winsorize_similarity_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_similarity_cast2 <- merge(data_summary_rank_winsorize_similarity_cast1,data_summary_rank_winsorize_similarity_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_similarity_cast3 <- data_summary_rank_winsorize_similarity_cast2[,sort(colnames(data_summary_rank_winsorize_similarity_cast2))]
data_summary_rank_winsorize_similarity_out <- data_summary_rank_winsorize_similarity_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_winsorize_similarity_cast3)[!(colnames(data_summary_rank_winsorize_similarity_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_winsorize_similarity_out <- data_summary_rank_winsorize_similarity_out[order(data_summary_rank_winsorize_similarity_out[,identifier]),]
row.names(data_summary_rank_winsorize_similarity_out) <- seq(nrow(data_summary_rank_winsorize_similarity_out))
write.csv(data_summary_rank_winsorize_similarity_out,file=paste(top_bot_out_path,"//","Rank_Winsorize_Similarity",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_winsorize_similarity_cast_data)
rm2(data_summary_rank_winsorize_similarity_cast0a,data_summary_rank_winsorize_similarity_cast0b,data_summary_rank_winsorize_similarity_cast0c)
rm2(data_summary_rank_winsorize_similarity_cast1,data_summary_rank_winsorize_similarity_cast2,data_summary_rank_winsorize_similarity_cast3)
## Tone
data_summary_rank_winsorize_tone_cast_data <- data_summary_rank_winsorize_trim4[data_summary_rank_winsorize_trim4[,"var_name"] %in% multivariate_vars_continuous_tone,]
data_summary_rank_winsorize_tone_cast0a <- unique(data_summary_rank_winsorize_tone_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_winsorize_tone_cast0b <- dcast(data=data_summary_rank_winsorize_tone_cast_data[,!(colnames(data_summary_rank_winsorize_tone_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_winsorize_tone_cast0c <- dcast(data=data_summary_rank_winsorize_tone_cast_data[,!(colnames(data_summary_rank_winsorize_tone_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_winsorize_tone_cast0c) <- paste(colnames(data_summary_rank_winsorize_tone_cast0c),"rank",sep="_")
colnames(data_summary_rank_winsorize_tone_cast0c)[1] <- identifier
data_summary_rank_winsorize_tone_cast1 <- merge(data_summary_rank_winsorize_tone_cast0a,data_summary_rank_winsorize_tone_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_tone_cast2 <- merge(data_summary_rank_winsorize_tone_cast1,data_summary_rank_winsorize_tone_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_winsorize_tone_cast3 <- data_summary_rank_winsorize_tone_cast2[,sort(colnames(data_summary_rank_winsorize_tone_cast2))]
data_summary_rank_winsorize_tone_out <- data_summary_rank_winsorize_tone_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_winsorize_tone_cast3)[!(colnames(data_summary_rank_winsorize_tone_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_winsorize_tone_out <- data_summary_rank_winsorize_tone_out[order(data_summary_rank_winsorize_tone_out[,identifier]),]
row.names(data_summary_rank_winsorize_tone_out) <- seq(nrow(data_summary_rank_winsorize_tone_out))
write.csv(data_summary_rank_winsorize_tone_out,file=paste(top_bot_out_path,"//","Rank_Winsorize_Tone",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_winsorize_tone_cast_data)
rm2(data_summary_rank_winsorize_tone_cast0a,data_summary_rank_winsorize_tone_cast0b,data_summary_rank_winsorize_tone_cast0c)
rm2(data_summary_rank_winsorize_tone_cast1,data_summary_rank_winsorize_tone_cast2,data_summary_rank_winsorize_tone_cast3)
rm2(data_summary_rank_winsorize_trim4,data_summary_rank_winsorize)
rm2(data_summary_rank_winsorize_readability_out,data_summary_rank_winsorize_similarity_out,data_summary_rank_winsorize_tone_out)
###############################################################################
cat("FIND TOP-3 FOR EACH TEXT MEASURE - NON WINSORIZE","\n")
###############################################################################
data_summary_rank_non_winsorize <- merge(data_summary_rank_lookup,unique(data_all1[,c(data_all_multivariate_full_cols_id,"yr",data_all_multivariate_full_cols_nonid)]),
by.x=c(identifier,"yr","Fund_Name"),by.y=c(identifier,"yr","Fund_Name"),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize <- data_summary_rank_non_winsorize[order(data_summary_rank_non_winsorize[,identifier]),]
row.names(data_summary_rank_non_winsorize) <- seq(nrow(data_summary_rank_non_winsorize))
data_summary_rank_non_winsorize <- data.frame(data_summary_rank_non_winsorize,
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"rank",sep="_"))),
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"top3",sep="_"))),
matrix(NA,ncol=length(data_all_multivariate_full_cols_nonid),nrow=1,dimnames=list(c(),paste(data_all_multivariate_full_cols_nonid,"bot3",sep="_"))),
stringsAsFactors=F)
data_summary_rank_non_winsorize_trim0 <- ldply(.data=data_all_multivariate_full_cols_nonid,.fun=function(x,data,id_cols){
# x <- data_all_multivariate_full_cols_nonid[[1]]
# data <- data_summary_rank_non_winsorize
# id_cols <- data_all_multivariate_full_cols_id
#cat(data_all_multivariate_full_cols_nonid[[i]], "\n")
temp_var <- unlist(x)
temp_vector <- data.frame(temp_col=sort(unique(data[,temp_var])),matrix(NA,ncol=3,nrow=1,dimnames=list(c(),c("temp_rank","temp_top3","temp_bot3"))),stringsAsFactors=F)
temp_vector[,"temp_rank"] <- seq(1,nrow(temp_vector))
temp_vector[,"temp_top3"] <-ifelse(temp_vector[,"temp_rank"] %in% tail(temp_vector[,"temp_rank"],3),temp_vector[,"temp_rank"],0)
temp_vector[,"temp_bot3"] <-ifelse(temp_vector[,"temp_rank"] %in% head(temp_vector[,"temp_rank"],3),temp_vector[,"temp_rank"],0)
temp_vector <- temp_vector[order(-temp_vector[,"temp_top3"]),]
temp_vector[,"temp_top3"] <- c("T1","T2","T3",rep(NA,nrow(temp_vector)-3))
temp_vector <- temp_vector[order(-temp_vector[,"temp_bot3"]),]
temp_vector[,"temp_bot3"] <- c("B3","B2","B1",rep(NA,nrow(temp_vector)-3))
temp_vector[,"temp_rank"] <- ifelse((is.na(temp_vector[,"temp_top3"]) & is.na(temp_vector[,"temp_bot3"])),NA,
ifelse((!is.na(temp_vector[,"temp_top3"]) & is.na(temp_vector[,"temp_bot3"])),temp_vector[,"temp_top3"],
ifelse((is.na(temp_vector[,"temp_top3"]) & !is.na(temp_vector[,"temp_bot3"])),temp_vector[,"temp_bot3"],
paste(temp_vector[,"temp_top3"],temp_vector[,"temp_bot3"],sep=","))))
colnames(temp_vector)[match("temp_col",names(temp_vector))] <- temp_var
colnames(temp_vector)[match("temp_rank",names(temp_vector))] <- paste(temp_var,"rank",sep="_")
colnames(temp_vector)[match("temp_top3",names(temp_vector))] <- paste(temp_var,"top3",sep="_")
colnames(temp_vector)[match("temp_bot3",names(temp_vector))] <- paste(temp_var,"bot3",sep="_")
data <- merge(data[,!(colnames(data) %in% paste(temp_var,c("rank","top3","bot3"),sep="_"))],temp_vector,
by.x=temp_var,by.y=temp_var,all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data <- data[order(data[,identifier]),]
row.names(data) <- seq(nrow(data))
data <- data[,c(id_cols,colnames(data)[!(colnames(data) %in% id_cols)])]
data <- data[,c(colnames(data)[!(colnames(data) %in% c(temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_")))],
c(temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_")))]
data_trim <- data.frame(var_name=NA,data[,c(id_cols,temp_var,paste(temp_var,c("rank","top3","bot3"),sep="_"))],stringsAsFactors=F)
colnames(data_trim)[match(temp_var,names(data_trim))] <- "var_value"
colnames(data_trim)[match(paste(temp_var,"rank",sep="_"),names(data_trim))] <- "rank"
colnames(data_trim)[match(paste(temp_var,"top3",sep="_"),names(data_trim))] <- "top3"
colnames(data_trim)[match(paste(temp_var,"bot3",sep="_"),names(data_trim))] <- "bot3"
data_trim[,"var_name"] <- temp_var
data_trim <- data_trim[,c(id_cols,colnames(data_trim)[!(colnames(data_trim) %in% id_cols)])]
rm(temp_var,temp_vector)
return(data_trim)
},data=data_summary_rank_non_winsorize,id_cols=data_all_multivariate_full_cols_id,.progress="none",.inform=F)
data_summary_rank_non_winsorize_trim1 <- data_summary_rank_non_winsorize_trim0[,colnames(data_summary_rank_non_winsorize_trim0)[!(colnames(data_summary_rank_non_winsorize_trim0) %in% c("top3","bot3"))]]
data_summary_rank_non_winsorize_trim2 <- data_summary_rank_non_winsorize_trim1[!(data_summary_rank_non_winsorize_trim1[,"var_name"] %in% c("quality_score_trim1_90_any_024","quality_score_trim1_90_avg_024","per_modalstrong","per_modalweak")),]
data_summary_rank_non_winsorize_trim3 <- data_summary_rank_non_winsorize_trim2[!((data_summary_rank_non_winsorize_trim2[,"var_name"] %in% c("per_litigious","per_negative","per_positive","per_uncertainty")) & (data_summary_rank_non_winsorize_trim2[,"var_value"]==0)),]
data_summary_rank_non_winsorize_trim4 <- data_summary_rank_non_winsorize_trim3[!is.na(data_summary_rank_non_winsorize_trim3[,"rank"]),]
rm(data_summary_rank_non_winsorize_trim0,data_summary_rank_non_winsorize_trim1,data_summary_rank_non_winsorize_trim2,data_summary_rank_non_winsorize_trim3)
## Readability
data_summary_rank_non_winsorize_readability_cast_data <- data_summary_rank_non_winsorize_trim4[data_summary_rank_non_winsorize_trim4[,"var_name"] %in% c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios","avg_grade_level_ios","words_ios"),]
data_summary_rank_non_winsorize_readability_cast0a <- unique(data_summary_rank_non_winsorize_readability_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_non_winsorize_readability_cast0b <- dcast(data=data_summary_rank_non_winsorize_readability_cast_data[,!(colnames(data_summary_rank_non_winsorize_readability_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_non_winsorize_readability_cast0c <- dcast(data=data_summary_rank_non_winsorize_readability_cast_data[,!(colnames(data_summary_rank_non_winsorize_readability_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_non_winsorize_readability_cast0c) <- paste(colnames(data_summary_rank_non_winsorize_readability_cast0c),"rank",sep="_")
colnames(data_summary_rank_non_winsorize_readability_cast0c)[1] <- identifier
data_summary_rank_non_winsorize_readability_cast1 <- merge(data_summary_rank_non_winsorize_readability_cast0a,data_summary_rank_non_winsorize_readability_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_readability_cast2 <- merge(data_summary_rank_non_winsorize_readability_cast1,data_summary_rank_non_winsorize_readability_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_readability_cast3 <- data_summary_rank_non_winsorize_readability_cast2[,sort(colnames(data_summary_rank_non_winsorize_readability_cast2))]
data_summary_rank_non_winsorize_readability_out <- data_summary_rank_non_winsorize_readability_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_non_winsorize_readability_cast3)[!(colnames(data_summary_rank_non_winsorize_readability_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_non_winsorize_readability_out <- data_summary_rank_non_winsorize_readability_out[order(data_summary_rank_non_winsorize_readability_out[,identifier]),]
row.names(data_summary_rank_non_winsorize_readability_out) <- seq(nrow(data_summary_rank_non_winsorize_readability_out))
write.csv(data_summary_rank_non_winsorize_readability_out,file=paste(top_bot_out_path,"//","Rank_Non_Winsorize_Readability",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_non_winsorize_readability_cast_data)
rm2(data_summary_rank_non_winsorize_readability_cast0a,data_summary_rank_non_winsorize_readability_cast0b,data_summary_rank_non_winsorize_readability_cast0c)
rm2(data_summary_rank_non_winsorize_readability_cast1,data_summary_rank_non_winsorize_readability_cast2,data_summary_rank_non_winsorize_readability_cast3)
## Similarity
data_summary_rank_non_winsorize_similarity_cast_data <- data_summary_rank_non_winsorize_trim4[data_summary_rank_non_winsorize_trim4[,"var_name"] %in% c("all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios"),]
data_summary_rank_non_winsorize_similarity_cast0a <- unique(data_summary_rank_non_winsorize_similarity_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_non_winsorize_similarity_cast0b <- dcast(data=data_summary_rank_non_winsorize_similarity_cast_data[,!(colnames(data_summary_rank_non_winsorize_similarity_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_non_winsorize_similarity_cast0c <- dcast(data=data_summary_rank_non_winsorize_similarity_cast_data[,!(colnames(data_summary_rank_non_winsorize_similarity_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_non_winsorize_similarity_cast0c) <- paste(colnames(data_summary_rank_non_winsorize_similarity_cast0c),"rank",sep="_")
colnames(data_summary_rank_non_winsorize_similarity_cast0c)[1] <- identifier
data_summary_rank_non_winsorize_similarity_cast1 <- merge(data_summary_rank_non_winsorize_similarity_cast0a,data_summary_rank_non_winsorize_similarity_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_similarity_cast2 <- merge(data_summary_rank_non_winsorize_similarity_cast1,data_summary_rank_non_winsorize_similarity_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_similarity_cast3 <- data_summary_rank_non_winsorize_similarity_cast2[,sort(colnames(data_summary_rank_non_winsorize_similarity_cast2))]
data_summary_rank_non_winsorize_similarity_out <- data_summary_rank_non_winsorize_similarity_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_non_winsorize_similarity_cast3)[!(colnames(data_summary_rank_non_winsorize_similarity_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_non_winsorize_similarity_out <- data_summary_rank_non_winsorize_similarity_out[order(data_summary_rank_non_winsorize_similarity_out[,identifier]),]
row.names(data_summary_rank_non_winsorize_similarity_out) <- seq(nrow(data_summary_rank_non_winsorize_similarity_out))
write.csv(data_summary_rank_non_winsorize_similarity_out,file=paste(top_bot_out_path,"//","Rank_Non_Winsorize_Similarity",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_non_winsorize_similarity_cast_data)
rm2(data_summary_rank_non_winsorize_similarity_cast0a,data_summary_rank_non_winsorize_similarity_cast0b,data_summary_rank_non_winsorize_similarity_cast0c)
rm2(data_summary_rank_non_winsorize_similarity_cast1,data_summary_rank_non_winsorize_similarity_cast2,data_summary_rank_non_winsorize_similarity_cast3)
## Tone
data_summary_rank_non_winsorize_tone_cast_data <- data_summary_rank_non_winsorize_trim4[data_summary_rank_non_winsorize_trim4[,"var_name"] %in% multivariate_vars_continuous_tone,]
data_summary_rank_non_winsorize_tone_cast0a <- unique(data_summary_rank_non_winsorize_tone_cast_data[,data_all_multivariate_full_cols_id])
data_summary_rank_non_winsorize_tone_cast0b <- dcast(data=data_summary_rank_non_winsorize_tone_cast_data[,!(colnames(data_summary_rank_non_winsorize_tone_cast_data) %in% c("rank"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="var_value")
data_summary_rank_non_winsorize_tone_cast0c <- dcast(data=data_summary_rank_non_winsorize_tone_cast_data[,!(colnames(data_summary_rank_non_winsorize_tone_cast_data) %in% c("var_value"))],
Fund_ID ~ var_name,margins=NULL,subset=NULL,fill=NULL,drop=F,value.var="rank")
colnames(data_summary_rank_non_winsorize_tone_cast0c) <- paste(colnames(data_summary_rank_non_winsorize_tone_cast0c),"rank",sep="_")
colnames(data_summary_rank_non_winsorize_tone_cast0c)[1] <- identifier
data_summary_rank_non_winsorize_tone_cast1 <- merge(data_summary_rank_non_winsorize_tone_cast0a,data_summary_rank_non_winsorize_tone_cast0b,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_tone_cast2 <- merge(data_summary_rank_non_winsorize_tone_cast1,data_summary_rank_non_winsorize_tone_cast0c,
by.x=c(identifier),by.y=c(identifier),all.x=T,all.y=F,sort=T,suffixes=c(".x",".y"))
data_summary_rank_non_winsorize_tone_cast3 <- data_summary_rank_non_winsorize_tone_cast2[,sort(colnames(data_summary_rank_non_winsorize_tone_cast2))]
data_summary_rank_non_winsorize_tone_out <- data_summary_rank_non_winsorize_tone_cast3[,c(data_all_multivariate_full_cols_id,
colnames(data_summary_rank_non_winsorize_tone_cast3)[!(colnames(data_summary_rank_non_winsorize_tone_cast3) %in% data_all_multivariate_full_cols_id)])]
data_summary_rank_non_winsorize_tone_out <- data_summary_rank_non_winsorize_tone_out[order(data_summary_rank_non_winsorize_tone_out[,identifier]),]
row.names(data_summary_rank_non_winsorize_tone_out) <- seq(nrow(data_summary_rank_non_winsorize_tone_out))
write.csv(data_summary_rank_non_winsorize_tone_out,file=paste(top_bot_out_path,"//","Rank_Non_Winsorize_Tone",".csv",sep=""),row.names=FALSE)
rm2(data_summary_rank_non_winsorize_tone_cast_data)
rm2(data_summary_rank_non_winsorize_tone_cast0a,data_summary_rank_non_winsorize_tone_cast0b,data_summary_rank_non_winsorize_tone_cast0c)
rm2(data_summary_rank_non_winsorize_tone_cast1,data_summary_rank_non_winsorize_tone_cast2,data_summary_rank_non_winsorize_tone_cast3)
rm2(data_summary_rank_non_winsorize_trim4,data_summary_rank_non_winsorize)
rm2(data_summary_rank_non_winsorize_readability_out,data_summary_rank_non_winsorize_similarity_out,data_summary_rank_non_winsorize_tone_out)
rm2(data_summary_rank_lookup)
###############################################################################
cat("REGRESSION - FINALIZE DATA","\n")
###############################################################################
#data_reg0 <- data_all_multivariate_full_trim
data_reg0 <- data_all_multivariate_full_trim[,!(colnames(data_all_multivariate_full_trim) %in% c("Fund_Name","Strategy"))]
data_reg <- data_reg0
#data_reg <- data_reg0[data_reg0[,paste(strat_col,"2",sep="")]!="OTHER2",]
rm2(data_reg0)
#rm2(data_all_multivariate_full)
# a <- data_all[data_all[,identifier]==5445,]
# a <- data_reg[,c(identifier,"yr","age_y","AUM","total_fee",multivariate_vars_continuous_tone,multivariate_vars_binary_fund,multivariate_vars_binary_tone)]
# a_na <- a[rowSums(is.na(a)) > 0,]
# rm(a,a_na)
#cor_data <- data_reg[,c("age_y_log","age_y","age_m_log","age_m","AUM_USm","AUM_USm_log","Fund_Size_USm","Fund_Size_USm_log","Firm_Size_combcol","Firm_Size_combcol_log","Fund_to_Firm_Size")]
#cor_data <- data_reg[,c("ARI_ios","Coleman_Liau_ios","Flesch_Kincaid_ios","FOG_ios","SMOG_ios","all_similarity_500pct_ios","Primary_Investment_Strategy_combcol_similarity_500pct_ios","per_litigious","per_negative","per_positive","per_uncertainty")]
#cor_test <- cor(as.matrix(cor_data),use="pairwise.complete.obs")
# b <-  data_reg[,c(identifier,"age_y_log","age_y","age_m_log","age_m")]
# c <-  data_reg[,c(identifier,revision_cols)]
###############################################################################
cat("REGRESSION - VARIABLES","\n")
###############################################################################
#pattern_str <- "kink_percent_PCT_ANYAVG_CUTOFF + indexrsq_percent_PCT_ANYAVG_CUTOFF + ar_1_percent_PCT_ANYAVG_CUTOFF + num_zero_percent_PCT_ANYAVG_CUTOFF + uniform_percent_PCT_ANYAVG_CUTOFF + string_percent_PCT_ANYAVG_CUTOFF + num_pairs_percent_PCT_ANYAVG_CUTOFF + per_negative_percent_PCT_ANYAVG_CUTOFF"
#quality_str <- "num_zero_percent_PCT_ANYAVG_CUTOFF + uniform_percent_PCT_ANYAVG_CUTOFF + string_percent_PCT_ANYAVG_CUTOFF + num_pairs_percent_PCT_ANYAVG_CUTOFF + per_negative_percent_PCT_ANYAVG_CUTOFF"
#nonquality_str <- "kink_percent_PCT_ANYAVG_CUTOFF  + indexrsq_percent_PCT_ANYAVG_CUTOFF + ar_1_percent_PCT_ANYAVG_CUTOFF"
#pb_str <- "kink_percent_PCT_ANYAVG_CUTOFF  + indexrsq_percent_PCT_ANYAVG_CUTOFF + ar_1_percent_PCT_ANYAVG_CUTOFF + num_zero_percent_PCT_ANYAVG_CUTOFF + uniform_percent_PCT_ANYAVG_CUTOFF + string_percent_PCT_ANYAVG_CUTOFF"
#read_str <- "ARI_ios + Coleman_Liau_ios + Flesch_Kincaid_ios + FOG_ios + SMOG_ios + avg_grade_level_ios"
#sim_type_all <- c("050pct","500pct","750pct","900pct")
strat_dvs <- paste("factor(",strat_col,")",sep="")
#strat_dvs <- paste("factor(",paste(strat_col,"2",sep=""),")",sep="")
# Continuous Dependents
#dep_input_cont_var <- c("quality_score_trim0","quality_score_trim1","quality_score_trim2","quality_score_trim3")
#dep_input_cont_var <- c("quality_score_trim0","quality_score_trim1")
dep_input_cont_var <- c("quality_score_trim1")
dep_input_cont0 <- ldply(.data=dep_input_cont_var,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=c(90,95,99),cols_out=c("score","pct"))
dep_input_cont1 <- adply(.data=dep_input_cont0,.margins=1,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=c("any","avg"),cols_out=c(colnames(dep_input_cont0),"any_avg"))
dep_input_cont2 <- adply(.data=dep_input_cont1,.margins=1,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=sprintf("%03d",c(24,36,48,60)),cols_out=c(colnames(dep_input_cont1),"cutoff"))
dep_input_cont <- data.frame(dep_input_cont2,dep_var=NA,stringsAsFactors=F)
dep_input_cont[,"dep_var"] <- paste(dep_input_cont[,"score"],dep_input_cont[,"pct"],dep_input_cont[,"any_avg"],dep_input_cont[,"cutoff"],sep="_")
rm2(dep_input_cont_var,dep_input_cont0,dep_input_cont1,dep_input_cont2)
# Binary Dependents
dep_input_bin_var <- c("per_positive_percent","num_zero_percent","per_repeats_percent","uniform_percent","string_percent",
"num_pairs_percent","per_negative_percent","ar_1_percent","indexrsq_percent","kink_percent")
dep_input_bin0 <- ldply(.data=dep_input_bin_var,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=c(90,95,99),cols_out=c("score","pct"))
dep_input_bin1 <- adply(.data=dep_input_bin0,.margins=1,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=c("any","avg"),cols_out=c(colnames(dep_input_bin0),"any_avg"))
dep_input_bin2 <- adply(.data=dep_input_bin1,.margins=1,.fun=function(x,expand_col,cols_out){
out <- data.frame(sapply(x,rep.int,times=length(expand_col)),temp_col=expand_col,stringsAsFactors=F)
colnames(out) <- cols_out
return(out)
},expand_col=sprintf("%03d",c(24,36,48,60)),cols_out=c(colnames(dep_input_bin1),"cutoff"))
dep_input_bin3 <- data.frame(dep_input_bin2,dep_var=NA,stringsAsFactors=F)
dep_input_bin3[,"dep_var"] <- paste(dep_input_bin3[,"score"],dep_input_bin3[,"pct"],dep_input_bin3[,"any_avg"],dep_input_bin3[,"cutoff"],sep="_")
dep_input_bin4 <- data.frame(matrix(NA,ncol=5,nrow=length(revision_cols),dimnames=list(c(),c("score","pct","any_avg","cutoff","dep_var"))),stringsAsFactors=F)
dep_input_bin4[,"dep_var"] <- revision_cols
dep_input_bin <- rbind(dep_input_bin3,dep_input_bin4)
rm2(dep_input_bin_var,dep_input_bin0,dep_input_bin1,dep_input_bin2,dep_input_bin3,dep_input_bin4)
str(data_reg,list.len=999)
multivariate_vars_continuous_text
corr_temp <- cor(data_reg[,c(quality_score_cols,multivariate_vars_continuous_text)], use="complete.obs")
View(corr_temp)
View(corr_temp)
utils::View(corr_temp)
View(corr_temp)
pattern_cols_all
pattern_cols_sub <- c("per_positive_percent","num_zero_percent","per_repeats_percent","uniform_percent",
"string_percent","num_pairs_percent","per_negative_percent","ar_1_percent","indexrsq_percent",
"kink_percent","quality_score_trim0","quality_score_trim1","quality_score_trim2","quality_score_trim3")
pattern_cols_all <- unique(unlist(lapply(pattern_cols_sub,function(x,cols){cols[grep(x,cols)]},cols=colnames(data_all))))
pattern_cols_all
corr_temp <- cor(data_reg[,unique(c(pattern_cols_all,quality_score_cols,multivariate_vars_continuous_text))], use="complete.obs")
pattern_cols_all
unique(c(pattern_cols_all,quality_score_cols,multivariate_vars_continuous_text))
corr_temp <- cor(data_reg[,colnames(data_reg) %in% unique(c(pattern_cols_all,quality_score_cols,multivariate_vars_continuous_text))], use="complete.obs")
View(corr_temp)
corr_temp <- cor(data_reg[,colnames(data_reg) %in% unique(c(pattern_cols_all,quality_score_cols,multivariate_vars_continuous_text))], use="complete.obs")
write.csv(corr_temp,file=paste(output_directory,"//","correlation","//","correlation_stars_PD_2",".csv",sep=""),row.names=FALSE)
View(corr_temp)
write.csv(corr_temp,file=paste(output_directory,"//","correlation","//","correlation_stars_PD_2",".csv",sep=""),row.names=TRUE)
write.csv(corr_temp,file=paste(output_directory,"//","correlation","//","correlation_stars_PD2",".csv",sep=""),row.names=TRUE)
